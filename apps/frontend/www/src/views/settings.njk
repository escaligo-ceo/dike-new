{% extends "layouts/layout.njk" %}

{% block title %}Impostazioni - Dike{% endblock %}

{% block content %}
<style>
  .settings-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 20px;
  }
  .settings-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 24px;
    align-items: start;
  }
  .settings-sidebar {
    position: sticky;
    top: 84px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 12px;
  }
  .settings-nav-group-title {
    font-size: 12px;
    color: #605e5c;
    margin: 8px 12px;
    text-transform: uppercase;
    letter-spacing: .03em;
  }
  .settings-nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    color: #323130;
    text-decoration: none;
    font-size: 14px;
  }
  .settings-nav-item:hover { background: #f7f7f7; }
  .settings-nav-divider {
    height: 1px;
    background: #e0e0e0;
    margin: 8px 0;
  }

  .settings-header {
    margin-bottom: 32px;
  }

  .settings-title {
    font-size: 32px;
    font-weight: 600;
    color: #323130;
    margin: 0 0 8px 0;
  }

  .settings-subtitle {
    font-size: 16px;
    color: #605e5c;
    margin: 0;
    line-height: 1.5;
  }

  .settings-card {
    background: white;
    border-radius: 8px;
    padding: 32px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 24px;
  }

  .settings-section-title {
    font-size: 20px;
    font-weight: 600;
    color: #323130;
    margin: 0 0 24px 0;
  }

  .settings-field {
    margin-bottom: 24px;
  }

  .settings-field:last-child {
    margin-bottom: 0;
  }

  .settings-field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .settings-field-label {
    font-weight: 600;
    color: #323130;
    font-size: 14px;
  }

  .settings-field-visibility {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #605e5c;
    font-size: 12px;
  }

  .settings-visibility-select {
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: #fff;
    color: #323130;
  }
  .settings-visibility-select:focus {
    outline: none;
    border-color: #0078d4;
  }

  /* Custom dropdown for visibility */
  .vis-dropdown {
    position: relative;
    display: inline-block;
    min-width: 240px;
  }
  .vis-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: #fff;
    font-size: 12px;
    color: #323130;
    cursor: pointer;
  }
  .vis-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 10;
    min-width: 280px;
    margin-top: 6px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    display: none;
  }
  .vis-menu.open { display: block; }
  .vis-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 12px;
    cursor: pointer;
  }
  .vis-item:hover { background: #f7f7f7; }
  .vis-item-icon { font-size: 16px; line-height: 16px; }
  .vis-item-content { display: flex; flex-direction: column; }
  .vis-item-title { font-size: 13px; color: #323130; }
  .vis-item-desc { font-size: 11px; color: #605e5c; }

  /* Visibility badges */
  /* (visibility badges removed per request) */

  .visibility-icon {
    width: 16px;
    height: 16px;
  }

  .settings-field-value {
    padding: 10px 12px;
    background-color: #f3f2f1;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    color: #323130;
    font-size: 14px;
  }

  .settings-field-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    color: #323130;
    box-sizing: border-box;
  }

  .settings-field-input:focus {
    outline: none;
    border-color: #0078d4;
  }

  .image-upload-section {
    display: flex;
    gap: 24px;
    margin-bottom: 24px;
  }

  .image-upload-item {
    flex: 1;
  }

  .image-upload-preview {
    width: 100%;
    height: 150px;
    border: 2px dashed #e0e0e0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    background-color: #fafafa;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .image-upload-preview:hover {
    border-color: #0078d4;
  }

  .image-upload-preview.avatar {
    height: 120px;
    border-radius: 50%;
    max-width: 120px;
    margin: 0 auto 8px;
  }

  .image-upload-preview svg {
    width: 32px;
    height: 32px;
    color: #a19f9d;
  }

  .image-upload-label {
    text-align: center;
    font-size: 12px;
    color: #605e5c;
  }

  .settings-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 32px;
  }

  .btn-primary {
    background-color: #0078d4;
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary:hover {
    background-color: #005a9e;
  }

  .btn-secondary {
    background-color: transparent;
    color: #323130;
    border: 1px solid #e0e0e0;
    padding: 10px 24px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-secondary:hover {
    background-color: #f3f2f1;
  }

  .divider {
    height: 1px;
    background-color: #e0e0e0;
    margin: 24px 0;
  }
</style>

{% macro visibilityDropdown(fieldKey, current) %}
  <div class="vis-dropdown" data-vis-field="{{ fieldKey }}">
    {% set labelMap = {
      'public': visibilityPublic,
      'tenant': visibilityTenant,
      'team': visibilityTeam,
      'private': visibilityPrivate
    } %}
    {% set iconMap = {
      'public': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15 15 0 0 0 0 20"/></svg>',
      'tenant': '<svg width="16" height="16" viewBox="0 0 24 24" role="presentation" xmlns="http://www.w3.org/2000/svg"><g fill="currentColor" fill-rule="evenodd"><path fill-rule="nonzero" d="M8 6H5.009C3.902 6 3 6.962 3 8.15v10.7C3 20.04 3.9 21 5.009 21h5.487H8v-2.145c-1.616-.001-3-.003-3-.004 0 0 .005-10.708.009-10.708L8 8.144z"></path><path d="M12 7h2v2h-2zm-6 3h2v2H6zm0 3h2v2H6zm6-3h2v2h-2zm0 3h2v2h-2zm2 3h2v3h-2zm2-9h2v2h-2zm0 3h2v2h-2zm0 3h2v2h-2z"></path><path fill-rule="nonzero" d="M18.991 19C18.998 19 19 4.995 19 4.995c0 .006-7.991.005-7.991.005C11.002 5 11 19 11 19zM9 4.995C9 3.893 9.902 3 11.009 3h7.982C20.101 3 21 3.893 21 4.995v14.01A2.004 2.004 0 0 1 18.991 21H9z"></path></g></svg>',
      'team': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><path d="M2 20a6 6 0 0 1 12 0M10 20a6 6 0 0 1 12 0"/></svg>',
      'private': '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'
    } %}
    {% set descMap = {
      'public': 'Visible to everyone',
      'tenant': 'Visible to your organisation',
      'team': 'Visible to your team',
      'private': 'Only you can see this'
    } %}
    {% set selected = current %}
    <button type="button" class="vis-button" aria-haspopup="listbox" aria-expanded="false">
      <span class="vis-item-icon">{{ iconMap[selected] | safe }}</span>
      <span class="vis-item-title">{{ labelMap[selected] }}</span>
    </button>
    <input type="hidden" name="visibility[{{ fieldKey }}]" value="{{ selected }}">
    <div class="vis-menu" role="listbox">
      {% for val in ['public','tenant','team','private'] %}
        <div class="vis-item" role="option" data-value="{{ val }}" aria-selected="{% if val == selected %}true{% else %}false{% endif %}">
          <span class="vis-item-icon">{{ iconMap[val] | safe }}</span>
          <div class="vis-item-content">
            <span class="vis-item-title">{{ labelMap[val] }}</span>
            <span class="vis-item-desc">{{ descMap[val] }}</span>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endmacro %}

<div class="settings-container">
  <div class="settings-header">
    <h1 class="settings-title">Profile and visibility</h1>
    <p class="settings-subtitle">
      Manage your personal information, and control which information other people see and apps may access.
    </p>
  </div>
  <div class="settings-layout">
    {% include "partials/settings-sidebar.njk" %}
    <div>
      <div class="settings-card">
        <h2 class="settings-section-title">Profile photo and header image</h2>
    
    <div class="image-upload-section">
      <div class="image-upload-item">
        <div class="image-upload-preview" onclick="document.getElementById('backgroundUpload').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <input type="file" id="backgroundUpload" accept="image/*" style="display: none;">
        </div>
        <div class="image-upload-label">Background image</div>
      </div>
      
      <div class="image-upload-item">
        <div class="image-upload-preview avatar" onclick="document.getElementById('avatarUpload').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
        </div>
        <div class="image-upload-label">Avatar image</div>
      </div>
    </div>

    <div class="divider"></div>

    <h2 class="settings-section-title">About you</h2>
    
    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Full name</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.fullName if visibility and visibility.fullName else 'public' %}
          {{ visibilityDropdown('fullName', __v) }}
        </div>
      </div>
      <input type="text" class="settings-field-input" value="Tommaso Centurioni">
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Public name</label>
      </div>
      <input type="text" class="settings-field-input" value="Tommaso Centurioni">
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Job title</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.jobTitle if visibility and visibility.jobTitle else 'public' %}
          {{ visibilityDropdown('jobTitle', __v) }}
        </div>
      </div>
      <input type="text" class="settings-field-input" value="Software Engineer">
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Department</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.department if visibility and visibility.department else 'team' %}
          {{ visibilityDropdown('department', __v) }}
        </div>
      </div>
      <div class="settings-field-value">Your department</div>
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Organisation</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.organisation if visibility and visibility.organisation else 'tenant' %}
          {{ visibilityDropdown('organisation', __v) }}
        </div>
      </div>
      <input type="text" class="settings-field-input" value="{{ tenant.name if tenant else '' }}" readonly>
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Based in</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.location if visibility and visibility.location else 'team' %}
          {{ visibilityDropdown('location', __v) }}
        </div>
      </div>
      <input type="text" class="settings-field-input" value="San Giovanni Lupatoto (Verona)">
    </div>

    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Local time</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.localTime if visibility and visibility.localTime else 'private' %}
          {{ visibilityDropdown('localTime', __v) }}
        </div>
      </div>
      <div class="settings-field-value">You have not set your time zone yet</div>
    </div>

    <div class="divider"></div>

    <h2 class="settings-section-title">Contact</h2>
    
    <div class="settings-field">
      <div class="settings-field-header">
        <label class="settings-field-label">Email address</label>
        <div class="settings-field-visibility">
          {% set __v = visibility.email if visibility and visibility.email else 'private' %}
          {{ visibilityDropdown('email', __v) }}
        </div>
      </div>
      <input type="email" class="settings-field-input" value="tommaso.centurioni@corvina.io">
    </div>

    <div class="settings-actions">
      <button class="btn-secondary" onclick="window.location.href='/profile'">Annulla</button>
      <button class="btn-primary" onclick="saveSettings()">Salva Modifiche</button>
    </div>
      </div>
    </div>
  </div>
</div>

<script>
  function saveSettings() {
    // TODO: Implement save functionality
    alert('Impostazioni salvate con successo!');
  }

  // Visibility dropdown behavior
  (function() {
    const dropdowns = document.querySelectorAll('.vis-dropdown');
    dropdowns.forEach(dd => {
      const button = dd.querySelector('.vis-button');
      const menu = dd.querySelector('.vis-menu');
      const hidden = dd.querySelector('input[type="hidden"]');

      function closeAllMenus() {
        document.querySelectorAll('.vis-menu.open').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.vis-button[aria-expanded="true"]').forEach(b => b.setAttribute('aria-expanded', 'false'));
      }

      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menu.classList.contains('open');
        closeAllMenus();
        if (!isOpen) {
          menu.classList.add('open');
          button.setAttribute('aria-expanded', 'true');
        }
      });

      menu.querySelectorAll('.vis-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const val = item.getAttribute('data-value');
          hidden.value = val;
          // Update button content (icon + title)
          const icon = item.querySelector('.vis-item-icon').textContent;
          const title = item.querySelector('.vis-item-title').textContent;
          button.querySelector('.vis-item-icon').textContent = icon;
          button.querySelector('.vis-item-title').textContent = title;

          // Update aria-selected
          menu.querySelectorAll('.vis-item').forEach(i => {
            i.setAttribute('aria-selected', i === item ? 'true' : 'false');
          });

          // Close menu
          menu.classList.remove('open');
          button.setAttribute('aria-expanded', 'false');
        });
      });
    });

    // Close on outside click or Escape
    document.addEventListener('click', () => {
      document.querySelectorAll('.vis-menu.open').forEach(m => m.classList.remove('open'));
      document.querySelectorAll('.vis-button[aria-expanded="true"]').forEach(b => b.setAttribute('aria-expanded', 'false'));
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.vis-menu.open').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.vis-button[aria-expanded="true"]').forEach(b => b.setAttribute('aria-expanded', 'false'));
      }
    });
  })();
</script>
{% endblock %}
